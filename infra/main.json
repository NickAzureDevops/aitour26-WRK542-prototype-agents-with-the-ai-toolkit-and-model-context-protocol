{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "10494837683179419664"
    }
  },
  "parameters": {
    "resourcePrefix": {
      "type": "string",
      "metadata": {
        "description": "Prefix for the resource group and resources"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Location of the resource group to create or use for the deployment"
      }
    },
    "aiProjectFriendlyName": {
      "type": "string",
      "defaultValue": "Agents standard project resource",
      "metadata": {
        "description": "Friendly name for your Azure AI resource"
      }
    },
    "aiProjectDescription": {
      "type": "string",
      "metadata": {
        "description": "Description of your Azure AI resource displayed in Azure AI Foundry"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Set of tags to apply to all resources."
      }
    },
    "models": {
      "type": "array",
      "defaultValue": [
        {
          "name": "gpt-4o",
          "format": "OpenAI",
          "version": "2024-08-06",
          "skuName": "GlobalStandard",
          "capacity": 80
        },
        {
          "name": "text-embedding-3-small",
          "format": "OpenAI",
          "version": "1",
          "skuName": "GlobalStandard",
          "capacity": 50
        }
      ],
      "metadata": {
        "description": "Array of models to deploy"
      }
    },
    "uniqueSuffix": {
      "type": "string",
      "minLength": 4,
      "maxLength": 4,
      "metadata": {
        "description": "Unique suffix for the resources. Must be 4 characters long."
      }
    }
  },
  "variables": {
    "resourceGroupName": "[toLower(format('rg-{0}-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix')))]",
    "defaultTags": {
      "source": "Azure AI Foundry Agents Service lab"
    },
    "rootTags": "[union(variables('defaultTags'), parameters('tags'))]",
    "aiProjectName": "[toLower(format('prj-{0}-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix')))]",
    "foundryResourceName": "[toLower(format('fdy-{0}-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix')))]",
    "applicationInsightsName": "[toLower(format('appi-{0}-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2024-11-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "application-insights-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "applicationInsightsName": {
            "value": "[variables('applicationInsightsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('rootTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14171859253243420895"
            }
          },
          "parameters": {
            "applicationInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Name for the Application Insights resource"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the Application Insights resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Set of tags to apply to all resources."
              }
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Name of the Log Analytics workspace (optional)"
              }
            }
          },
          "resources": [
            {
              "condition": "[empty(parameters('logAnalyticsWorkspaceName'))]",
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[format('law-{0}', parameters('applicationInsightsName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "features": {
                  "searchVersion": 1,
                  "legacy": 0,
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('applicationInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[if(empty(parameters('logAnalyticsWorkspaceName')), resourceId('Microsoft.OperationalInsights/workspaces', format('law-{0}', parameters('applicationInsightsName'))), resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')))]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('law-{0}', parameters('applicationInsightsName')))]"
              ]
            }
          ],
          "outputs": {
            "applicationInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))]"
            },
            "applicationInsightsName": {
              "type": "string",
              "value": "[parameters('applicationInsightsName')]"
            },
            "instrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "connectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName')), '2020-02-02').ConnectionString]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[if(empty(parameters('logAnalyticsWorkspaceName')), resourceId('Microsoft.OperationalInsights/workspaces', format('law-{0}', parameters('applicationInsightsName'))), resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "foundry-account-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiProjectName": {
            "value": "[variables('aiProjectName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('rootTags')]"
          },
          "foundryResourceName": {
            "value": "[variables('foundryResourceName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17578706800367264156"
            }
          },
          "parameters": {
            "aiProjectName": {
              "type": "string",
              "metadata": {
                "description": "Name for the project"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Set of tags to apply to all resources."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the Azure AI Foundry resource"
              }
            },
            "foundryResourceName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 24,
              "metadata": {
                "description": "Name of the Azure AI Foundry account"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-04-01-preview",
              "name": "[parameters('foundryResourceName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "S0"
              },
              "kind": "AIServices",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "apiProperties": {},
                "allowProjectManagement": true,
                "customSubDomainName": "[parameters('foundryResourceName')]",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "virtualNetworkRules": [],
                  "ipRules": []
                },
                "publicNetworkAccess": "Enabled",
                "disableLocalAuth": false,
                "defaultProject": "[parameters('aiProjectName')]",
                "associatedProjects": [
                  "[parameters('aiProjectName')]"
                ]
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "accountName": {
              "type": "string",
              "value": "[parameters('foundryResourceName')]"
            },
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('foundryResourceName')), '2025-04-01-preview').endpoints['AI Foundry API']]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "foundry-project-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "foundryResourceName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'foundry-account-deployment'), '2025-04-01').outputs.accountName.value]"
          },
          "aiProjectName": {
            "value": "[variables('aiProjectName')]"
          },
          "aiProjectFriendlyName": {
            "value": "[parameters('aiProjectFriendlyName')]"
          },
          "aiProjectDescription": {
            "value": "[parameters('aiProjectDescription')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('rootTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "931780011899150071"
            }
          },
          "parameters": {
            "foundryResourceName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 24,
              "metadata": {
                "description": "Name of the Azure AI Foundry account"
              }
            },
            "aiProjectName": {
              "type": "string",
              "metadata": {
                "description": "Name for the project"
              }
            },
            "aiProjectFriendlyName": {
              "type": "string",
              "metadata": {
                "description": "Friendly name for your Azure AI resource"
              }
            },
            "aiProjectDescription": {
              "type": "string",
              "metadata": {
                "description": "Description of your Azure AI resource displayed in Azure AI Foundry"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Model deployment location. If you want to deploy an Azure AI resource/model in different location than the rest of the resources created."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Set of tags to apply to all resources."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts/projects",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}', parameters('foundryResourceName'), parameters('aiProjectName'))]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "description": "[parameters('aiProjectDescription')]",
                "displayName": "[parameters('aiProjectFriendlyName')]"
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "aiProjectId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('foundryResourceName'), parameters('aiProjectName'))]"
            },
            "aiProjectName": {
              "type": "string",
              "value": "[parameters('aiProjectName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'foundry-account-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "copy": {
        "name": "foundryModelDeployments",
        "count": "[length(parameters('models'))]",
        "mode": "serial",
        "batchSize": 1
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('foundry-model-deployment-{0}-{1}', parameters('models')[copyIndex()].name, copyIndex())]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "foundryResourceName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'foundry-account-deployment'), '2025-04-01').outputs.accountName.value]"
          },
          "modelName": {
            "value": "[parameters('models')[copyIndex()].name]"
          },
          "modelFormat": {
            "value": "[parameters('models')[copyIndex()].format]"
          },
          "modelVersion": {
            "value": "[parameters('models')[copyIndex()].version]"
          },
          "modelSkuName": {
            "value": "[parameters('models')[copyIndex()].skuName]"
          },
          "modelCapacity": {
            "value": "[parameters('models')[copyIndex()].capacity]"
          },
          "tags": {
            "value": "[variables('rootTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8710155655568217848"
            }
          },
          "parameters": {
            "foundryResourceName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 24,
              "metadata": {
                "description": "Name of the Azure AI Foundry account"
              }
            },
            "modelName": {
              "type": "string",
              "metadata": {
                "description": "Model name for deployment"
              }
            },
            "modelFormat": {
              "type": "string",
              "metadata": {
                "description": "Model format for deployment"
              }
            },
            "modelVersion": {
              "type": "string",
              "metadata": {
                "description": "Model version for deployment"
              }
            },
            "modelSkuName": {
              "type": "string",
              "metadata": {
                "description": "Model deployment SKU name"
              }
            },
            "modelCapacity": {
              "type": "int",
              "metadata": {
                "description": "Model deployment capacity"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Set of tags to apply to all resources."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-10-01",
              "name": "[format('{0}/{1}', parameters('foundryResourceName'), parameters('modelName'))]",
              "sku": {
                "capacity": "[parameters('modelCapacity')]",
                "name": "[parameters('modelSkuName')]"
              },
              "properties": {
                "model": {
                  "name": "[parameters('modelName')]",
                  "format": "[parameters('modelFormat')]",
                  "version": "[parameters('modelVersion')]"
                },
                "versionUpgradeOption": "OnceNewDefaultVersionAvailable",
                "currentCapacity": "[parameters('modelCapacity')]"
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "modelDeploymentId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts/deployments', parameters('foundryResourceName'), parameters('modelName'))]"
            },
            "modelDeploymentName": {
              "type": "string",
              "value": "[parameters('modelName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'foundry-account-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'foundry-project-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    }
  ],
  "outputs": {
    "subscriptionId": {
      "type": "string",
      "value": "[subscription().subscriptionId]"
    },
    "resourceGroupName": {
      "type": "string",
      "value": "[variables('resourceGroupName')]"
    },
    "aiFoundryName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'foundry-account-deployment'), '2025-04-01').outputs.accountName.value]"
    },
    "aiProjectName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'foundry-project-deployment'), '2025-04-01').outputs.aiProjectName.value]"
    },
    "projectsEndpoint": {
      "type": "string",
      "value": "[format('{0}api/projects/{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'foundry-account-deployment'), '2025-04-01').outputs.endpoint.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'foundry-project-deployment'), '2025-04-01').outputs.aiProjectName.value)]"
    },
    "deployedModels": {
      "type": "array",
      "copy": {
        "count": "[length(parameters('models'))]",
        "input": {
          "name": "[parameters('models')[copyIndex()].name]",
          "deploymentName": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('foundry-model-deployment-{0}-{1}', parameters('models')[copyIndex()].name, copyIndex())), '2025-04-01').outputs.modelDeploymentName.value]"
        }
      }
    },
    "applicationInsightsName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'application-insights-deployment'), '2025-04-01').outputs.applicationInsightsName.value]"
    },
    "applicationInsightsConnectionString": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'application-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
    },
    "applicationInsightsInstrumentationKey": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'application-insights-deployment'), '2025-04-01').outputs.instrumentationKey.value]"
    }
  }
}